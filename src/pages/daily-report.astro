---
import { fetchDailyReport } from '@/lib/server/fetch-daily-report'
import SiteLayout from '@/layouts/SiteLayout.astro'
import { marked } from 'marked'
import HeroImage from '@/components/astro/HeroImage.astro'
import HeroTitle from '@/components/astro/HeroTitle.astro'
import Prose from '@/components/astro/Prose.astro'
import { PageMetrics } from '@/components/blog/PageMetrics'
import { Download } from 'lucide-react'

Astro.response.headers.set('Cache-Control', 'public, max-age=60, s-maxage=60')
// Astro.response.headers.set('Pragma', 'no-cache')
// Astro.response.headers.set('Expires', '0')

export const prerender = false

const DEFAULT_LIMIT = 300

// parse url parameters
const url = new URL(Astro.url)
const limit = Number(url.searchParams.get('limit') ?? DEFAULT_LIMIT)
const paramDate = url.searchParams.get('date') ?? undefined
const date = paramDate ? new Date(paramDate) : new Date()
const refreshStr = url.searchParams.get('refresh')
const refresh = refreshStr === 'true' || Number(refreshStr) > 0
const hardRefresh = refreshStr === 'hard'

// fetch or generate the report
const report = await fetchDailyReport({ date, limit, refresh, hardRefresh })

// process content for meta tags, html, etc.
const content = await marked(report.text)
const bgImage = '/images/bolsnbers4.png'
const today = date
const title = 'The Daily Report'
const currentDate = today.toLocaleDateString('en-US', { dateStyle: 'full' })

// extract useful information from markdown
function getDetailedSummary() {
  const summary = report.text
  try {
    const pageTitle = summary.slice(4, summary.indexOf('**') - 2)
    const indexOfSummary = summary.indexOf('Macro')
    const macro = summary.slice(indexOfSummary)
    const description = macro.slice(macro.indexOf('\n') + 1, macro.indexOf('###') - 2)
    const ogDescription = `${pageTitle} • ${description}`
    return ogDescription
  } catch (e) {
    return summary.slice(4, Math.min(600, summary.length))
  }
}

const description = getDetailedSummary()
---

<SiteLayout title={`${title} | ${currentDate}`} description={description} image={bgImage}>
  <article class="flex flex-col items-center w-full max-w-3xl text-gray-800 md:pt-16 pb-8">
    <HeroImage src={bgImage} alt={`Daily Report | ${currentDate}`} />
    <HeroTitle title={title} pubDate={today} />

    <Prose>
      <Fragment set:html={content} />
    </Prose>

    <div class="my-4 mx-2 md:mx-0 p-4 bg-yellow-50 border-l-4 border-yellow-400 rounded">
      <p class="text-sm text-gray-700 leading-relaxed">
        <strong class="font-semibold text-gray-900">⚠️ Disclaimer:</strong>
        Data sourced from
        <a
          href="https://www.reddit.com/r/wallstreetbets/"
          target="_blank"
          rel="noopener noreferrer"
          class="text-blue-600 hover:text-blue-800 underline font-medium"
        >
          r/WallStreetBets
        </a>
        and analyzed with Grok AI. Not financial advice. Information is subject to change. Trade at your own risk.
      </p>
    </div>
    <button
      onclick="window.print()"
      class="no-print hidden mx-2 md:mx-0 px-8 flex flec-row gap-x-4 py-1.5 squircle my-4 bg-blue-500 text-white text-sm hover:bg-blue-600"
    >
      <Download size={16} />
      <span class="test-sm font-mono">Download as PDF</span>
    </button>
    <PageMetrics className="mb-4 no-print mx-auto shrink" enableDownload client:only="react" />
  </article>
</SiteLayout>

<style is:global>
  @import 'tailwindcss';
  h1 {
    @apply text-6xl font-black tracking-tight pb-4;
  }
  h2 {
    @apply text-3xl font-bold;
  }
  h3 {
    @apply text-2xl font-bold;
  }
  h4 {
    @apply text-xl font-bold;
  }

  article a {
    font-weight: 600;
  }

  article a:hover {
    @apply text-green-500!;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.875rem;
    border: 1px solid #e5e7eb;
  }

  thead tr {
    background-color: #f9fafb;
    border-bottom: 1px solid #e5e7eb;
  }

  th {
    padding: 0.5rem 1rem;
    text-align: left;
    font-weight: 600;
    color: #374151;
  }

  tbody tr {
    border-bottom: 1px solid #f3f4f6;
    transition: background-color 0.2s;
  }

  tbody tr:nth-child(odd) {
    background-color: #ffffff;
  }

  tbody tr:nth-child(even) {
    background-color: #f9fafb;
  }

  tbody tr:hover {
    background-color: #f3f4f6;
  }

  td {
    padding: 0.75rem 1rem;
    color: #4b5563;
  }

  td a {
    color: #2563eb;
    text-decoration: none;
  }

  td a:hover {
    text-decoration: underline;
  }

  ul,
  ol {
    margin: 0px 0px !important;
    font-size: 1rem !important;
  }

  .table-wrapper {
    overflow-x: auto;
  }

  /* Mobile responsive */
  @media (max-width: 640px) {
    table {
      font-size: 0.8125rem;
    }

    th,
    td {
      padding: 0.5rem 0.75rem;
    }
  }

  /* Print styles */
  @media print {
    /* Hide elements not needed in PDF */
    nav,
    footer,
    button,
    header,
    .no-print {
      display: none !important;
    }

    /* Remove URL/date headers and footers */
    @page {
      margin: 0.5in;
    }

    /* Hide link URLs that appear after links */
    a[href]::after {
      content: none !important;
    }

    /* Optimize article for print */
    article {
      max-width: 100% !important;
      padding: 0 !important;
      margin: 0 !important;
    }

    /* Remove background colors for better printing */
    body {
      background: white !important;
    }

    /* Ensure links are visible */
    a {
      color: #2563eb !important;
      text-decoration: underline !important;
    }

    /* Page breaks */
    h1,
    h2,
    h3 {
      page-break-after: avoid;
    }

    /* Keep images reasonable size */
    img {
      max-width: 100%;
      page-break-inside: avoid;
    }
  }
</style>
