---
import { fetchDailyReport } from '@/lib/server/fetch-daily-report'
import SiteLayout from '@/layouts/SiteLayout.astro'
import { marked } from 'marked'
import HeroImage from '@/components/astro/HeroImage.astro'
import HeroTitle from '@/components/astro/HeroTitle.astro'
import Prose from '@/components/astro/Prose.astro'

const DEFAULT_LIMIT = 300
const url = new URL(Astro.url)

const limit = Number(url.searchParams.get('limit') ?? DEFAULT_LIMIT)
const refreshStr = url.searchParams.get('refresh')
const refresh = refreshStr === 'true' || Number(refreshStr) > 0

const report = await fetchDailyReport({ limit, refresh })
const content = marked(report.summary)

const title = 'The Daily Report'
const bgImage = '/images/bolsnbers4.png'

const today = new Date()
const currentDate = today.toLocaleDateString('en-US', { dateStyle: 'full' })
const description = `Daily analysis of WSB's hottest stock picks, market sentiment, and options plays for ${currentDate}. SPY predictions, trending tickers, and what traders are watching.`
---

<SiteLayout title={title} description={description} image={bgImage}>
  <article class="flex flex-col max-w-3xl gap-y-4 mx-auto px-4 py-16">
    <HeroImage src={bgImage} alt={`Daily Report | ${currentDate}`} />
    <HeroTitle title={title} pubDate={today} />

    <Prose>
      <Fragment set:html={content} />
    </Prose>

    <div class="mt-8 p-4 bg-yellow-50 border-l-4 border-yellow-400 rounded">
      <p class="text-sm text-gray-700 leading-relaxed">
        <strong class="font-semibold text-gray-900">⚠️ Disclaimer:</strong>
        Data sourced from
        <a
          href="https://www.reddit.com/r/wallstreetbets/"
          target="_blank"
          rel="noopener noreferrer"
          class="text-blue-600 hover:text-blue-800 underline font-medium"
        >
          r/WallStreetBets
        </a>
        and analyzed with Grok AI. Not financial advice. Information is subject to change. Trade at your own risk.
      </p>
    </div>
    <button
      onclick="window.print()"
      class="no-print px-4 py-2 mt-8 bg-blue-500 text-white rounded-xl hover:bg-blue-600"
    >
      Download as PDF
    </button>
  </article>
</SiteLayout>

<style is:global>
  @import 'tailwindcss';
  h1 {
    @apply text-6xl font-black tracking-tight pb-4;
  }
  h2 {
    @apply text-3xl font-bold;
  }
  h3 {
    @apply text-2xl font-bold;
  }
  h4 {
    @apply text-xl font-bold;
  }

  article a {
    font-weight: 600;
  }

  article a:hover {
    @apply text-green-500!;
  }

  /* Print styles */
  @media print {
    /* Hide elements not needed in PDF */
    nav,
    footer,
    button,
    header,
    .no-print {
      display: none !important;
    }

    /* Remove URL/date headers and footers */
    @page {
      margin: 0.5in;
    }

    /* Hide link URLs that appear after links */
    a[href]::after {
      content: none !important;
    }

    /* Optimize article for print */
    article {
      max-width: 100% !important;
      padding: 0 !important;
      margin: 0 !important;
    }

    /* Remove background colors for better printing */
    body {
      background: white !important;
    }

    /* Ensure links are visible */
    a {
      color: #2563eb !important;
      text-decoration: underline !important;
    }

    /* Page breaks */
    h1,
    h2,
    h3 {
      page-break-after: avoid;
    }

    /* Keep images reasonable size */
    img {
      max-width: 100%;
      page-break-inside: avoid;
    }
  }
</style>
