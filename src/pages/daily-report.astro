---
import { fetchDailyReport, triggerDailyReportRefreshInBackground } from '@/lib/server/fetch-daily-report'
import SiteLayout from '@/layouts/SiteLayout.astro'
import { marked } from 'marked'
import HeroImage from '@/components/astro/HeroImage.astro'
import HeroTitle from '@/components/astro/HeroTitle.astro'
import Prose from '@/components/astro/Prose.astro'
import BlogDisclaimer from '@/components/astro/BlogDisclaimer.astro'
import { PageMetrics } from '@/components/blog/PageMetrics'
import { getDailyReport, getLatestDailyReport, type DailyReport } from '@/lib/db/daily-reports'
import { stockMarket } from '@/lib/utils/stock-market'
import StockBadge from './partials/stock-badge.astro'
import DailyReportCard from '@/components/astro/DailyReportCard.astro'

// set page cache for ~1 min
Astro.response.headers.set('Cache-Control', 'public, max-age=60, s-maxage=60')

export const prerender = false

// default limit of wsb comments to fetch
const DEFAULT_LIMIT = 300

// parse url parameters
const url = new URL(Astro.url)
const limit = Number(url.searchParams.get('limit') ?? DEFAULT_LIMIT)
const paramDate = url.searchParams.get('date') ?? undefined
const date = paramDate ? new Date(paramDate) : stockMarket.getCurrentOrUpcomingTradingDay()
const refreshStr = url.searchParams.get('refresh')
const refresh = Boolean(refreshStr && ['null', 'undefined', '0', 'false'].every((str) => refreshStr !== str))
const hardRefresh = refreshStr === 'hard'

if (refresh || hardRefresh) {
  await fetchDailyReport({ date, limit, refresh, hardRefresh })
}

// start a refresh in background
// if (!refresh && !hardRefresh) {
//   void triggerDailyReportRefreshInBackground({ date })
// }

// get latest version of daily report from database
// const report = await fetchDailyReport({ date, limit, refresh, hardRefresh })
const report = (await getDailyReport({ date })) ?? (await getLatestDailyReport())

if (!report) {
  return Astro.redirect('/404')
}

// calculate staleness (~15mins)
const lastUpdated = report.updated_at ? new Date(report.updated_at) : new Date(report.market_date)
const elapsed = stockMarket.getElapsedTimeSince(lastUpdated)
// const isStale = elapsed.mins > 15

// process content for meta tags, html, etc.
const content = await marked(report.summary)
const bgImage = '/images/bolsnbers4.png'
const today = date
const title = 'The Daily Report'
const currentDate = today.toLocaleDateString('en-US', { dateStyle: 'full' })

// extract useful information from markdown
function getDetailedSummary() {
  if (!report) throw new Error('Missing daily report!')
  const summary = report.summary
  try {
    const pageTitle = summary.slice(4, summary.indexOf('**') - 2)
    const indexOfSummary = summary.indexOf('Macro')
    const macro = summary.slice(indexOfSummary)
    const description = macro.slice(macro.indexOf('\n') + 1, macro.indexOf('###') - 2)
    const ogDescription = `${pageTitle} â€¢ ${description}`
    return ogDescription
  } catch (e) {
    return summary.slice(4, Math.min(600, summary.length))
  }
}

const description = getDetailedSummary()

function getElapsedDetail() {
  if (elapsed.secs === 0) return 'now'
  if (elapsed.mins === 0) return `${elapsed.secs} secs ago`
  if (elapsed.hours === 0) return `${elapsed.mins} mins ago`
  if (elapsed.days === 0) return `${elapsed.hours} hours ago`
  return stockMarket.getDateString(date)
}

const reportCard = report.data?.reportCard
const reportDate = date.toLocaleDateString('en-US', { dateStyle: 'long' })
---

<SiteLayout title={`${title} | ${currentDate}`} description={description} image={bgImage} htmx>
  <article class="flex flex-col items-center w-full max-w-full lg:max-w-3xl text-gray-800 md:pt-16 pb-8">
    <!-- Daily Report Header -->
    <HeroImage src={bgImage} alt={`Daily Report | ${currentDate}`} />
    <HeroTitle title={title} pubDate={today} class="gap-y-2 hero-title" dividerClass="my-1 md:my-3">
      <!-- dynamic stock prices in header -->
      <div aria-label="Stock Prices" class="flex items-center justify-center pb-2">
        <StockBadge ticker="SPY" format="advanced" />
      </div>
    </HeroTitle>

    <!-- Daily Report Content -->
    <Prose>
      <Fragment set:html={content} />
    </Prose>

    <!-- Display Report Card If Present -->
    {
      reportCard && (
        <Fragment>
          <div class="p-2" />
          <DailyReportCard {...reportCard} date={reportDate} />
          <div class="p-2" />
        </Fragment>
      )
    }

    <!-- Daily Report Footer -->
    <BlogDisclaimer>
      Data sourced from
      <a
        href="https://www.reddit.com/r/wallstreetbets/"
        target="_blank"
        rel="noopener noreferrer"
        class="text-orange-500 hover:text-orange-800! underline font-medium"
      >
        r/WallStreetBets
      </a>
      and analyzed with Grok AI. Not financial advice. Information is subject to change. Trade at your own risk.
      <p class="text-sm text-[10px] mt-1 text-gray-700 text-right">
        Last updated {getElapsedDetail()}.
      </p>
    </BlogDisclaimer>
    <PageMetrics className="mb-4 no-print mx-auto shrink" client:load />
  </article>
  <!-- we giving back to the community -->
  <script define:vars={{ report }}>
    window.dailyReport = report
    console.log(report)
  </script>
</SiteLayout>

<style is:global>
  @import 'tailwindcss';
  h1 {
    @apply text-4xl md:text-5xl font-black tracking-tight pb-4;
  }
  h2 {
    @apply text-3xl font-bold;
  }
  h3 {
    @apply text-2xl font-bold;
  }
  h4 {
    @apply text-xl font-bold;
  }

  h2:has(+ .summary-content),
  /* or target by text if needed */
  h2:nth-last-of-type(1) {
    page-break-before: always;
  }

  article a {
    font-weight: 600;
  }

  article a:hover {
    @apply text-green-500!;
  }

  .daily-report-links {
    @apply flex items-center flex-nowrap justify-center px-8 gap-x-4 py-2 bg-blue-50 rounded-xl mx-auto *:no-underline! *:hover:underline!;
  }

  .daily-report-links-div {
    @apply mx-2 h-6 bg-neutral-200;
    width: 2px;
  }

  .daily-report-links a {
    @apply text-blue-400! uppercase no-underline! hover:text-blue-800! hover:scale-105 duration-300 transition-all text-xs! truncate line-clamp-1;
  }

  .table-header-centered {
    @apply font-black block mx-auto text-center;
  }

  .spy-eod-container {
    @apply flex flex-col gap-4 items-center justify-center bg-neutral-100 border border-neutral-200 px-4 py-8 mx-4 hover:animate-pulse;
  }

  .spy-eod-label {
    @apply text-xs! font-mono font-semibold! text-neutral-400! tracking-wide!;
    font-size: 0.8rem !important;
  }

  .spy-eod-confidence {
    @apply text-xs! font-light font-mono! text-gray-400! uppercase -mt-1 tracking-tight!;
  }

  .spy-eod-summary {
    @apply font-normal! text-neutral-800! text-pretty! mx-5 leading-5;
    font-size: 0.84rem !important;
  }

  .spy-eod {
    @apply text-5xl! font-black;
  }

  .revisions-table-wrapper {
    @apply hidden overflow-y-auto overflow-x-hidden max-h-96;
  }

  .final-word {
    @apply italic text-center text-sm font-bold mx-4 text-pretty;
    font-size: 0.75rem;
  }

  table {
    width: calc(100% - 1rem);
    border-collapse: collapse;
    font-size: 0.875rem;
    border: 1px solid #e5e7eb;
    margin-right: 1rem;
  }

  thead tr {
    background-color: #f9fafb;
    border-bottom: 1px solid #e5e7eb;
  }

  th {
    padding: 0.5rem 1rem;
    text-align: left;
    font-weight: 600;
    color: #374151;
  }

  tbody tr {
    border-bottom: 1px solid #f3f4f6;
    transition: background-color 0.2s;
  }

  tbody tr:nth-child(odd) {
    background-color: #ffffff;
  }

  tbody tr:nth-child(even) {
    background-color: #f9fafb;
  }

  tbody tr:hover {
    background-color: #f3f4f6;
  }

  td {
    padding: 0.75rem 1rem;
    color: #4b5563;
  }

  td a {
    color: #2563eb;
    text-decoration: none;
  }

  td a:hover {
    text-decoration: underline;
  }

  td .bear {
    @apply text-red-500 mx-auto block text-3xl font-bold text-center;
  }
  td .bull {
    @apply text-green-500 mx-auto block text-3xl font-bold text-center;
  }

  ul,
  ol {
    margin: 0px 0px !important;
    font-size: 1rem !important;
  }

  .table-wrapper {
    overflow-x: auto;
  }

  /* Mobile responsive */
  @media (max-width: 640px) {
    table {
      font-size: 0.8125rem;
    }

    th,
    td {
      padding: 0.5rem 0.75rem;
    }
  }

  /* Print styles */
  @media print {
    @page {
      margin: 0.5in 0.6in;
      size: letter;
    }

    .stock-badge,
    .spy-eod-container,
    .disclaimer,
    #report-card,
    thead tr {
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    /* Hide all scrollbars */
    * {
      overflow: visible !important;
    }

    /* Hide elements not needed in PDF */
    nav,
    footer,
    button,
    header,
    .no-print {
      display: none !important;
    }

    /* Prevent orphaned headers/content */
    h1,
    h2,
    h3,
    h4 {
      page-break-after: avoid;
      break-after: avoid;
    }

    #report-card {
      page-break-inside: avoid;
    }

    p,
    li,
    tr {
      orphans: 3;
      widows: 3;
    }

    /* Keep tables together when possible */
    table,
    .spy-eod-container {
      page-break-inside: avoid;
      break-inside: avoid;
    }

    .hero-title {
      margin: 0.5in auto;
    }

    /* Shrink hero image for print */
    .hero-image {
      max-height: 80px;
      object-fit: cover;
      margin-bottom: 24px;
    }

    /* Hide link URLs that appear after links */
    a[href]::after {
      content: none !important;
    }

    /* Tighten spacing */
    article {
      max-width: 100% !important;
      font-size: 11pt;
      line-height: 1.4;
    }

    /* Cleaner tables */
    table {
      font-size: 10pt;
      width: 100%;
    }

    tbody tr {
      border-bottom: 1px solid #f3f4f6;
      transition: background-color 0.2s;
    }

    tbody tr:nth-child(odd) {
      background-color: #ffffff;
    }

    tbody tr:nth-child(even) {
      background-color: #f9fafb;
    }

    .stock-badge {
      background-color: black !important;
    }

    /* Remove background colors for better printing */
    body {
      background: white !important;
    }

    /* Ensure links are visible */
    a {
      color: #2563eb !important;
      text-decoration: underline !important;
    }

    /* Page breaks */
    h1,
    h2,
    h3 {
      page-break-after: avoid;
    }

    /* Keep images reasonable size */
    img {
      border-radius: 8px;
      max-width: 100%;
      page-break-inside: avoid;
      aspect-ratio: 16 / 9;
    }
  }
</style>
