---
import { fetchDailyReport } from '@/lib/server/fetch-daily-report'
import SiteLayout from '@/layouts/SiteLayout.astro'
import { marked } from 'marked'
import HeroImage from '@/components/astro/HeroImage.astro'
import HeroTitle from '@/components/astro/HeroTitle.astro'
import Prose from '@/components/astro/Prose.astro'
import BlogDisclaimer from '@/components/astro/BlogDisclaimer.astro'
import { PageMetrics } from '@/components/blog/PageMetrics'
import { getDailyReport, type DailyReport } from '@/lib/db/daily-reports'
import { sleep } from 'bun'

// set page cache for ~1 min
Astro.response.headers.set('Cache-Control', 'public, max-age=60, s-maxage=60')

export const prerender = false

// default limit of wsb comments to fetch
const DEFAULT_LIMIT = 300

// parse url parameters
const url = new URL(Astro.url)
const limit = Number(url.searchParams.get('limit') ?? DEFAULT_LIMIT)
const paramDate = url.searchParams.get('date') ?? undefined
const date = paramDate ? new Date(paramDate) : new Date()
const refreshStr = url.searchParams.get('refresh')
const refresh = Boolean(refreshStr && ['null', 'undefined', '0', 'false'].every((str) => refreshStr !== str))
const hardRefresh = refreshStr === 'hard'

async function fetchCachedBeforeTimeout(): Promise<DailyReport> {
  await sleep(10_000) // client times out ~60s
  console.warn('[daily-report] falling back on cached version before dealine...')
  return await getDailyReport({ date })
}

// fetch or generate the report (fallback on cache before timeout)
const report: DailyReport = await Promise.race([
  fetchDailyReport({ date, limit, refresh, hardRefresh }),
  fetchCachedBeforeTimeout(),
])

// process content for meta tags, html, etc.
const content = await marked(report.text)
const bgImage = '/images/bolsnbers4.png'
const today = date
const title = 'The Daily Report'
const currentDate = today.toLocaleDateString('en-US', { dateStyle: 'full' })

// extract useful information from markdown
function getDetailedSummary() {
  const summary = report.text
  try {
    const pageTitle = summary.slice(4, summary.indexOf('**') - 2)
    const indexOfSummary = summary.indexOf('Macro')
    const macro = summary.slice(indexOfSummary)
    const description = macro.slice(macro.indexOf('\n') + 1, macro.indexOf('###') - 2)
    const ogDescription = `${pageTitle} • ${description}`
    return ogDescription
  } catch (e) {
    return summary.slice(4, Math.min(600, summary.length))
  }
}

const description = getDetailedSummary()
---

<SiteLayout title={`${title} | ${currentDate}`} description={description} image={bgImage}>
  <article
    class="flex flex-col overflow-x-hidden items-center w-full max-w-full md:max-w-3xl text-gray-800 md:pt-16 pb-8"
  >
    <HeroImage src={bgImage} alt={`Daily Report | ${currentDate}`} />
    <HeroTitle title={title} pubDate={today} />
    <Prose>
      <Fragment set:html={content} />
    </Prose>
    <BlogDisclaimer>
      Data sourced from
      <a
        href="https://www.reddit.com/r/wallstreetbets/"
        target="_blank"
        rel="noopener noreferrer"
        class="text-orange-500 hover:text-orange-800! underline font-medium"
      >
        r/WallStreetBets
      </a>
      and analyzed with Grok AI. Not financial advice. Information is subject to change. Trade at your own risk.
    </BlogDisclaimer>
    <PageMetrics className="mb-4 no-print mx-auto shrink" enableDownload client:only="react" />
  </article>
  <!-- we giving back to the community -->
  <script define:vars={{ report }}>
    console.log('❤️ for all you scrapers out there (window.dailyReport)...')
    window.dailyReport = report
    console.log(report)
  </script>
</SiteLayout>

<style is:global>
  @import 'tailwindcss';
  h1 {
    @apply text-6xl font-black tracking-tight pb-4;
  }
  h2 {
    @apply text-3xl font-bold;
  }
  h3 {
    @apply text-2xl font-bold;
  }
  h4 {
    @apply text-xl font-bold;
  }

  article a {
    font-weight: 600;
  }

  article a:hover {
    @apply text-green-500!;
  }

  .daily-report-links {
    @apply flex items-center flex-nowrap justify-center px-8 gap-x-4 py-2 bg-blue-50 rounded-xl mx-auto *:no-underline! *:hover:underline!;
  }

  .daily-report-links-div {
    @apply mx-2 h-6 bg-neutral-200;
    width: 2px;
  }

  .daily-report-links a {
    @apply text-blue-400! uppercase no-underline! hover:text-blue-800! hover:scale-105 duration-300 transition-all text-xs! truncate line-clamp-1;
  }

  .table-header-centered {
    @apply font-black block mx-auto text-center;
  }

  .spy-eod-container {
    @apply flex flex-col gap-4 items-center justify-center bg-neutral-100 border border-neutral-200 px-4 py-8 mx-4 hover:animate-pulse;
  }

  .spy-eod-label {
    @apply text-xs! font-mono font-semibold! text-neutral-400! tracking-wide!;
    font-size: 0.8rem !important;
  }

  .spy-eod-confidence {
    @apply text-xs! font-light! font-mono! text-neutral-300! uppercase -mt-1 tracking-tight!;
  }

  .spy-eod-summary {
    @apply font-normal! text-neutral-800! text-pretty! mx-5 leading-5;
    font-size: 0.84rem !important;
  }

  .spy-eod {
    @apply text-5xl! font-black;
  }

  .revisions-table-wrapper {
    @apply overflow-y-auto overflow-x-hidden max-h-96;
  }

  .final-word {
    @apply italic text-center text-sm font-bold mx-4 text-pretty;
    font-size: 0.75rem;
  }

  table {
    width: calc(100% - 1rem);
    border-collapse: collapse;
    font-size: 0.875rem;
    border: 1px solid #e5e7eb;
    margin-right: 1rem;
  }

  thead tr {
    background-color: #f9fafb;
    border-bottom: 1px solid #e5e7eb;
  }

  th {
    padding: 0.5rem 1rem;
    text-align: left;
    font-weight: 600;
    color: #374151;
  }

  tbody tr {
    border-bottom: 1px solid #f3f4f6;
    transition: background-color 0.2s;
  }

  tbody tr:nth-child(odd) {
    background-color: #ffffff;
  }

  tbody tr:nth-child(even) {
    background-color: #f9fafb;
  }

  tbody tr:hover {
    background-color: #f3f4f6;
  }

  td {
    padding: 0.75rem 1rem;
    color: #4b5563;
  }

  td a {
    color: #2563eb;
    text-decoration: none;
  }

  td a:hover {
    text-decoration: underline;
  }

  td .bear {
    @apply text-red-500 mx-auto block text-3xl font-bold text-center;
  }
  td .bull {
    @apply text-green-500 mx-auto block text-3xl font-bold text-center;
  }

  ul,
  ol {
    margin: 0px 0px !important;
    font-size: 1rem !important;
  }

  .table-wrapper {
    overflow-x: auto;
  }

  /* Mobile responsive */
  @media (max-width: 640px) {
    table {
      font-size: 0.8125rem;
    }

    th,
    td {
      padding: 0.5rem 0.75rem;
    }
  }

  /* Print styles */
  @media print {
    /* Hide elements not needed in PDF */
    nav,
    footer,
    button,
    header,
    .no-print {
      display: none !important;
    }

    /* Remove URL/date headers and footers */
    @page {
      margin: 0.5in;
    }

    /* Hide link URLs that appear after links */
    a[href]::after {
      content: none !important;
    }

    /* Optimize article for print */
    article {
      max-width: 100% !important;
      padding: 0 !important;
      margin: 0 !important;
    }

    /* Remove background colors for better printing */
    body {
      background: white !important;
    }

    /* Ensure links are visible */
    a {
      color: #2563eb !important;
      text-decoration: underline !important;
    }

    /* Page breaks */
    h1,
    h2,
    h3 {
      page-break-after: avoid;
    }

    /* Keep images reasonable size */
    img {
      max-width: 100%;
      page-break-inside: avoid;
    }
  }
</style>
