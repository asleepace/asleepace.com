---
import BaseHead from '@/components/astro/BaseHead.astro'
import { Play, Settings, ChevronDown, FileText, Plus, Save } from 'lucide-react'

export const prerender = false

const data = Astro.url.searchParams.get('data')

const initialCodeData = data
  ? Buffer.from(data, 'base64')
  : `const greeting: string = "Hello, TypeScript!"
console.log(greeting)

function add(a: number, b: number): number {
  return a + b
}

console.log(\`2 + 3 = \${add(2, 3)}\`)

// Try editing and running your code!`
---

<!doctype html>
<html lang="en" class="h-full">
  <head>
    <BaseHead title={'Code'} description={'a simple online code playground.'} />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <style>
      /* GitHub Dark Theme Colors */
      :root {
        --gh-bg-darker: #010409;
        --gh-bg-canvas: #0d1117;
        --gh-bg-default: #161b22;
        --gh-bg-secondary: #21262d;
        --gh-bg-tertiary: #30363d;
        --gh-border-default: #30363d;
        --gh-text-primary: #c9d1d9;
        --gh-text-secondary: #8b949e;
        --gh-accent-blue: #58a6ff;
        --gh-accent-blue-hover: #1f6feb;
        --gh-success: #238636;
        --gh-success-hover: #2ea043;

        /* iOS Safe Area */
        --safe-area-inset-top: env(safe-area-inset-top, 0px);
        --safe-area-inset-right: env(safe-area-inset-right, 0px);
        --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
        --safe-area-inset-left: env(safe-area-inset-left, 0px);
      }

      /* Custom scrollbar for output panel, settings modal, and files dropdown */
      #output-content::-webkit-scrollbar,
      #settings-body::-webkit-scrollbar,
      #files-dropdown::-webkit-scrollbar {
        width: 10px;
        height: 10px;
      }

      #output-content::-webkit-scrollbar-track,
      #settings-body::-webkit-scrollbar-track,
      #files-dropdown::-webkit-scrollbar-track {
        background: transparent;
      }

      #output-content::-webkit-scrollbar-thumb,
      #settings-body::-webkit-scrollbar-thumb,
      #files-dropdown::-webkit-scrollbar-thumb {
        background: var(--gh-border-default);
        border-radius: 5px;
        border: 2px solid transparent;
        background-clip: padding-box;
      }

      #output-content::-webkit-scrollbar-thumb:hover,
      #settings-body::-webkit-scrollbar-thumb:hover,
      #files-dropdown::-webkit-scrollbar-thumb:hover {
        background: var(--gh-accent-blue);
        border: 2px solid transparent;
        background-clip: padding-box;
      }

      #output-content::-webkit-scrollbar-corner,
      #settings-body::-webkit-scrollbar-corner,
      #files-dropdown::-webkit-scrollbar-corner {
        background: transparent;
      }

      /* Loading spinner animation */
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .loading-spinner {
        animation: spin 1s linear infinite;
      }

      /* Fade in animation */
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .fade-in {
        animation: fadeIn 0.3s ease-in;
      }

      /* Utility classes using CSS variables */
      .bg-gh-darker {
        background-color: var(--gh-bg-darker);
      }
      .bg-gh-canvas {
        background-color: var(--gh-bg-canvas);
      }
      .bg-gh-default {
        background-color: var(--gh-bg-default);
      }
      .bg-gh-secondary {
        background-color: var(--gh-bg-secondary);
      }
      .bg-gh-tertiary {
        background-color: var(--gh-bg-tertiary);
      }
      .border-gh {
        border-color: var(--gh-border-default);
      }
      .text-gh-primary {
        color: var(--gh-text-primary);
      }
      .text-gh-secondary {
        color: var(--gh-text-secondary);
      }
      .bg-gh-accent {
        background-color: var(--gh-accent-blue);
      }
      .text-gh-accent {
        color: var(--gh-accent-blue);
      }
      .bg-gh-success {
        background-color: var(--gh-success);
      }

      .hover\:bg-gh-tertiary:hover {
        background-color: var(--gh-bg-tertiary);
      }
      .hover\:bg-gh-accent-hover:hover {
        background-color: var(--gh-accent-blue-hover);
      }
      .hover\:bg-gh-success-hover:hover {
        background-color: var(--gh-success-hover);
      }
      .hover\:text-gh-primary:hover {
        color: var(--gh-text-primary);
      }
      .hover\:text-gh-accent:hover {
        color: var(--gh-accent-blue);
      }
      .hover\:border-gh:hover {
        border-color: var(--gh-border-default);
      }
      .focus\:border-gh-accent:focus {
        border-color: var(--gh-accent-blue);
      }
      .accent-gh-accent {
        accent-color: var(--gh-accent-blue);
      }
      .active\:bg-gh-success-hover:active {
        background-color: var(--gh-success-hover);
      }

      /* iOS Safe Area Support */
      body {
        padding-left: var(--safe-area-inset-left);
        padding-right: var(--safe-area-inset-right);
      }

      /* Toolbar safe area */
      #toolbar {
        padding-top: var(--safe-area-inset-top);
      }

      /* Output panel safe area */
      #output {
        padding-bottom: var(--safe-area-inset-bottom);
      }

      #output-content {
        padding-bottom: calc(0.75rem + var(--safe-area-inset-bottom));
      }

      /* Settings modal safe area */
      #settings-modal {
        padding-top: var(--safe-area-inset-top);
        padding-bottom: var(--safe-area-inset-bottom);
      }
    </style>
  </head>
  <body class="h-full m-0 flex flex-col overflow-hidden bg-gh-canvas">
    <!-- Toolbar -->
    <div id="toolbar" class="bg-gh-darker border-b border-gh flex items-center h-12 px-4 pr-2 gap-2 shrink-0 z-50">
      <div class="flex items-center gap-2">
        <span class="text-sm font-medium text-gh-primary tracking-wide">TypeScript</span>
        <span id="ts-version" class="text-xs text-gh-secondary font-mono">v5.9.3</span>
      </div>

      <!-- Version Dropdown -->
      <div class="relative ml-2">
        <button
          id="version-btn"
          class="flex items-center gap-1.5 px-3 pl-3.5 py-1.5 text-xs leading-4 text-indigo-400 *:hover:text-indigo-500 border border-neutral-800 hover:border-indigo-400 rounded transition-colors"
        >
          <span id="selected-version" class="tracking-wide">ES2022</span>
          <div class="h-4 w-[1px] bg-neutral-800 mx-0.5"></div>
          <ChevronDown className="text-neutral-500" size={14} />
        </button>
        <div
          id="version-dropdown"
          class="hidden absolute top-full mt-1 left-0 bg-gh-default border border-gh rounded shadow-lg z-50 min-w-[120px] text-blue-400 tracking-wide *:hover:bg-neutral-800"
        >
          {
            ['ES5', 'ES2015', 'ES2020', 'ES2022', 'ESNext'].map((tsVersion) => {
              return (
                <button
                  class="version-option w-full px-3 py-2 text-xs text-left text-gh-primary hover:text-orange-400 transition-colors"
                  data-version={tsVersion}
                >
                  {tsVersion}
                </button>
              )
            })
          }
        </div>
      </div>

      <!-- Files Dropdown -->
      <div class="relative mr-2">
        <button
          id="files-btn"
          class="flex items-center gap-1.5 px-3 pl-3.5 py-1.5 text-xs leading-4 text-gh-primary border border-neutral-800 hover:border-gh-accent rounded transition-colors"
        >
          <FileText size={14} className="text-gh-secondary" />
          <span id="selected-file" class="tracking-wide max-w-[150px] truncate">New File</span>
          <div class="h-4 w-[1px] bg-neutral-800 mx-0.5"></div>
          <ChevronDown className="text-neutral-500" size={14} />
        </button>
        <div
          id="files-dropdown"
          class="hidden absolute top-full mt-1 left-0 bg-gh-default border border-gh rounded shadow-lg z-50 min-w-[200px] max-h-[300px] overflow-y-auto"
        >
          <!-- New File Button -->
          <button
            id="new-file-btn"
            class="w-full px-3 py-2 text-xs text-left text-gh-accent hover:bg-gh-secondary transition-colors flex items-center gap-2 border-b border-gh"
          >
            <Plus size={14} />
            <span>New File</span>
          </button>
          <!-- Files will be populated here dynamically -->
          <div id="files-list" class="text-blue-400 tracking-wide *:hover:text-orange-400 *:hover:bg-neutral-800"></div>
        </div>
      </div>

      <!-- Settings and Action Buttons -->
      <div class="flex flex-row ml-auto rounded overflow-clip">
        <button
          id="settings-btn"
          class="flex items-center gap-1.5 pr-3.5 pl-4 py-1.5 text-xs text-gh-primary bg-gh-secondary hover:bg-gh-tertiary transition-colors"
        >
          <Settings size={14} />
        </button>

        <button
          id="save-btn"
          class="flex items-center gap-1.5 pr-3.5 pl-3.5 py-1.5 text-xs text-gh-primary bg-gh-secondary hover:bg-gh-tertiary transition-colors border-l border-gh"
          title="Save file (Ctrl/Cmd+S)"
        >
          <Save size={14} />
          <span class="tracking-wide">Save</span>
        </button>

        <button
          id="run-btn"
          class="self-stretch flex items-center gap-2 pl-3 pr-3.5 py-1.5 bg-indigo-500 text-white text-xs font-medium hover:bg-gh-success-hover active:bg-gh-success-hover transition-colors duration-150"
        >
          <Play size={16} strokeWidth={2} />
          <span class="tracking-wider mt-0.5">Run</span>
        </button>
      </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="absolute inset-0 flex items-center justify-center bg-gh-canvas">
      <div class="flex flex-col items-center gap-4">
        <svg
          class="loading-spinner w-12 h-12 text-indigo-500"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
        >
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path
            class="opacity-75"
            fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
          ></path>
        </svg>
        <div class="text-center">
          <p class="text-sm font-medium text-gh-primary">Loading Editor</p>
          <p class="text-xs text-gh-secondary mt-1">Initializing Monaco & TypeScript...</p>
        </div>
      </div>
    </div>

    <!-- Editor -->
    <div id="editor" class="flex-1 overflow-hidden opacity-0"></div>

    <!-- Output Panel -->
    <div id="output" class="hidden border-t border-gh bg-gh-darker shrink-0" style="height: 200px;">
      <!-- Resize Handle -->
      <div
        id="resize-handle"
        class="h-1 bg-gh-tertiary hover:bg-gh-accent cursor-ns-resize transition-colors group relative"
      >
        <div class="absolute inset-x-0 top-1/2 -translate-y-1/2 h-5 flex items-center justify-center">
          <div class="w-12 h-0.5 bg-gh-secondary group-hover:bg-gh-accent transition-colors"></div>
        </div>
      </div>
      <div class="flex items-center justify-between px-4 py-2 bg-gh-canvas border-b border-gh">
        <span class="text-xs font-medium text-gh-primary uppercase tracking-wider">Output</span>
        <button id="clear-output" class="text-xs text-gh-secondary hover:text-gh-primary transition-colors"
          >Clear</button
        >
      </div>
      <div id="output-content" class="px-4 py-3 overflow-auto" style="height: calc(100% - 37px);">
        <pre id="output-text" class="text-sm font-mono text-green-500 leading-relaxed"></pre>
      </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="hidden fixed inset-0 bg-black/60 z-50 items-center justify-center">
      <div class="bg-gh-default border border-gh rounded-lg w-full max-w-md mx-4 shadow-2xl">
        <!-- Modal Header -->
        <div class="flex items-center justify-between px-5 py-4 border-b border-gh">
          <h2 class="text-base font-semibold text-gh-primary">Editor Settings</h2>
          <button id="close-settings" class="text-gh-secondary hover:text-gh-primary transition-colors">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 6L6 18M6 6l12 12"></path>
            </svg>
          </button>
        </div>

        <!-- Modal Body -->
        <div id="settings-body" class="px-5 py-4 space-y-4 max-h-[60vh] overflow-y-auto">
          <!-- Font Size -->
          <div>
            <label class="block text-xs font-medium text-gh-primary mb-2">Font Size</label>
            <input
              id="font-size"
              type="range"
              min="10"
              max="24"
              value="14"
              class="w-full h-1.5 bg-gh-secondary rounded-lg appearance-none cursor-pointer accent-gh-accent"
            />
            <div class="flex justify-between text-xs text-gh-secondary mt-1">
              <span>10px</span>
              <span id="font-size-value">14px</span>
              <span>24px</span>
            </div>
          </div>

          <!-- Line Height -->
          <div>
            <label class="block text-xs font-medium text-gh-primary mb-2">Line Height</label>
            <input
              id="line-height"
              type="range"
              min="16"
              max="32"
              value="22"
              class="w-full h-1.5 bg-gh-secondary rounded-lg appearance-none cursor-pointer accent-gh-accent"
            />
            <div class="flex justify-between text-xs text-gh-secondary mt-1">
              <span>16px</span>
              <span id="line-height-value">22px</span>
              <span>32px</span>
            </div>
          </div>

          <!-- Minimap -->
          <div class="flex items-center justify-between">
            <label class="text-xs font-medium text-gh-primary">Show Minimap</label>
            <button
              id="minimap-toggle"
              class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors bg-gh-secondary"
              data-enabled="false"
            >
              <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform translate-x-1"
              ></span>
            </button>
          </div>

          <!-- Font Ligatures -->
          <div class="flex items-center justify-between">
            <label class="text-xs font-medium text-gh-primary">Font Ligatures</label>
            <button
              id="ligatures-toggle"
              class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors bg-gh-accent"
              data-enabled="true"
            >
              <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform translate-x-6"
              ></span>
            </button>
          </div>

          <!-- Line Numbers -->
          <div class="flex items-center justify-between">
            <label class="text-xs font-medium text-gh-primary">Line Numbers</label>
            <button
              id="line-numbers-toggle"
              class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors bg-gh-accent"
              data-enabled="true"
            >
              <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform translate-x-6"
              ></span>
            </button>
          </div>

          <!-- Divider -->
          <div class="border-t border-gh my-4"></div>

          <!-- TypeScript Options Header -->
          <div class="mb-3">
            <h3 class="text-sm font-semibold text-gh-primary">TypeScript Compiler Options</h3>
            <p class="text-xs text-gh-secondary mt-0.5">Configure how TypeScript compiles your code</p>
          </div>

          <!-- Strict Mode -->
          <div class="flex items-center justify-between">
            <div>
              <label class="text-xs font-medium text-gh-primary">Strict Mode</label>
              <p class="text-xs text-gh-secondary mt-0.5">Enable all strict type checking options</p>
            </div>
            <button
              id="strict-toggle"
              class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors bg-gh-secondary"
              data-enabled="false"
            >
              <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform translate-x-1"
              ></span>
            </button>
          </div>

          <!-- No Implicit Any -->
          <div class="flex items-center justify-between">
            <div>
              <label class="text-xs font-medium text-gh-primary">No Implicit Any</label>
              <p class="text-xs text-gh-secondary mt-0.5">Raise error on expressions with implied 'any' type</p>
            </div>
            <button
              id="no-implicit-any-toggle"
              class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors bg-gh-secondary"
              data-enabled="false"
            >
              <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform translate-x-1"
              ></span>
            </button>
          </div>

          <!-- Strict Null Checks -->
          <div class="flex items-center justify-between">
            <div>
              <label class="text-xs font-medium text-gh-primary">Strict Null Checks</label>
              <p class="text-xs text-gh-secondary mt-0.5">Differentiate between null/undefined and other types</p>
            </div>
            <button
              id="strict-null-checks-toggle"
              class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors bg-gh-secondary"
              data-enabled="false"
            >
              <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform translate-x-1"
              ></span>
            </button>
          </div>

          <!-- No Unused Locals -->
          <div class="flex items-center justify-between">
            <div>
              <label class="text-xs font-medium text-gh-primary">No Unused Locals</label>
              <p class="text-xs text-gh-secondary mt-0.5">Report errors on unused local variables</p>
            </div>
            <button
              id="no-unused-locals-toggle"
              class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors bg-gh-secondary"
              data-enabled="false"
            >
              <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform translate-x-1"
              ></span>
            </button>
          </div>

          <!-- No Unused Parameters -->
          <div class="flex items-center justify-between">
            <div>
              <label class="text-xs font-medium text-gh-primary">No Unused Parameters</label>
              <p class="text-xs text-gh-secondary mt-0.5">Report errors on unused function parameters</p>
            </div>
            <button
              id="no-unused-parameters-toggle"
              class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors bg-gh-secondary"
              data-enabled="false"
            >
              <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform translate-x-1"
              ></span>
            </button>
          </div>

          <!-- Module System -->
          <div>
            <label class="block text-xs font-medium text-gh-primary mb-2">Module System</label>
            <select
              id="module-select"
              class="w-full px-3 py-2 text-xs bg-gh-secondary text-gh-primary rounded border border-gh hover:border-gh focus:outline-none focus:border-gh-accent transition-colors"
            >
              <option value="None">None</option>
              <option value="CommonJS">CommonJS</option>
              <option value="AMD">AMD</option>
              <option value="UMD">UMD</option>
              <option value="System">System</option>
              <option value="ES2015" selected>ES2015/ES6</option>
              <option value="ES2020">ES2020</option>
              <option value="ESNext">ESNext</option>
            </select>
          </div>
        </div>

        <!-- Modal Footer -->
        <div class="flex items-center justify-end gap-2 px-5 py-4 border-t border-gh">
          <button
            id="reset-settings"
            class="px-4 py-2 text-xs font-medium text-gh-primary hover:text-white transition-colors"
          >
            Reset to Default
          </button>
          <button
            id="apply-settings"
            class="px-4 py-2 text-xs font-medium bg-gh-accent text-white rounded hover:bg-gh-accent-hover transition-colors"
          >
            Apply
          </button>
        </div>
      </div>
    </div>

    <script is:inline src="https://unpkg.com/monaco-editor@latest/min/vs/loader.js"></script>
    <script is:inline src="https://unpkg.com/typescript@latest/lib/typescript.js"></script>
    <script async>
      /**
       * ## Database
       *
       * A simple wrapper around our IndexDB for Code.
       *
       * @returns {{
       *  name: string,
       *  db: IndexDB,
       *  files: any[],
       *  lastEntry: readonly {name: string; code:string; createdAt: Date; updatedAt: Date; id: number} | null
       *  isInitialized: readonly boolean
       *  createFileName(): string
       *  initialize: Promise<this>
       *  save(code: string, fileName?: string): Promise<void>
       *  getByKey(key: string): Promise<any | null>
       *  getByName(name: string): Promise<any | null>
       *  transaction(callbackFn: (store: any) => void): void
       *  update(id: string, code: string): void
       * }}
       */
      function CodeDB() {
        const DB_NAME = 'CodeDB'
        const STORE_NAME = 'code'

        const handleError = (ev) => {
          console.warn(`[IndexDB:${DB_NAME}] error:`, ev)
          this.db = null
        }

        const createFileName = () =>
          new Date()
            .toLocaleDateString('en-US', { dateStyle: 'medium' })
            .replaceAll(' ', '_')
            .replaceAll(',', '')
            .toLowerCase()
            .concat('_')
            .concat(crypto.randomUUID().slice(0, 4))
            .concat('.ts')

        return {
          name: DB_NAME,
          db: null,
          store: null,
          files: [],
          createFileName,
          get lastEntry() {
            return this.files.at(-1)?.data
          },
          get isInitialized() {
            return Boolean(this.db)
          },
          async initialize() {
            return new Promise((resolve) => {
              const request = window.indexedDB.open(DB_NAME, 2) // Increment version
              request.onerror = handleError
              request.onsuccess = (ev) => {
                console.log(`[IndexDB:${DB_NAME}] opened`)
                this.db = ev.target.result
                this.forEach((file) => {
                  if (!file) return
                  this.files.push(file)
                })
                resolve(this)
              }
              request.onupgradeneeded = (ev) => {
                console.log(`[IndexDB:${DB_NAME}] onupgradeneeded`)
                this.db = ev.target.result

                // Create or get store
                let store
                if (!this.db.objectStoreNames.contains(STORE_NAME)) {
                  store = this.db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true })
                } else {
                  store = ev.target.transaction.objectStore(STORE_NAME)
                }

                // Create indexes
                if (!store.indexNames.contains('name')) {
                  store.createIndex('name', 'name', { unique: false })
                }
                if (!store.indexNames.contains('createdAt')) {
                  store.createIndex('createdAt', 'createdAt', { unique: false })
                }
                if (!store.indexNames.contains('updatedAt')) {
                  store.createIndex('updatedAt', 'updatedAt', { unique: false })
                }
                if (!store.indexNames.contains('meta')) {
                  store.createIndex('meta', 'meta', { unique: false })
                }

                this.store = store
              }
            })
          },
          transaction(callback) {
            if (!this.isInitialized) return void console.warn('DB: Not initialized!')
            const transaction = this.db.transaction([STORE_NAME], 'readwrite')
            const store = transaction.objectStore(STORE_NAME)
            return callback(store)
          },
          save(code, callback) {
            // Extract filename from @file comment (e.g., @file myfile.ts)
            const FILE_NAME_REGEX = /@file\s+([^\s*]+)/i
            const match = code.match(FILE_NAME_REGEX)
            const name = match ? match[1] : createFileName()

            console.log('Saving file:', name)

            const now = Date.now()
            const entry = {
              name: name,
              code,
              createdAt: now,
              updatedAt: now,
              meta: {
                tsVersion: null,
              },
            }
            this.transaction((objectStore) => {
              const request = objectStore.add(entry)
              request.onsuccess = () => {
                console.log('File saved successfully:', name, 'ID:', request.result)
                if (callback) {
                  callback({ id: request.result, name: name })
                }
              }
              request.onerror = (e) => {
                console.error('Error saving file:', e)
              }
            })
          },
          update(id, code, callback) {
            // Extract filename from @file comment
            const FILE_NAME_REGEX = /@file\s+([^\s*]+)/i
            const match = code.match(FILE_NAME_REGEX)

            this.transaction((objectStore) => {
              const getRequest = objectStore.get(id)
              getRequest.onsuccess = () => {
                const existing = getRequest.result
                if (existing) {
                  existing.code = code
                  existing.updatedAt = Date.now()
                  // Update name if @file comment changed
                  if (match) {
                    existing.name = match[1]
                  }
                  const putRequest = objectStore.put(existing)
                  putRequest.onsuccess = () => {
                    console.log('File updated successfully:', existing.name)
                    if (callback) {
                      callback({ id: existing.id, name: existing.name })
                    }
                  }
                  putRequest.onerror = (e) => {
                    console.error('Error updating file:', e)
                  }
                }
              }
              getRequest.onerror = (e) => {
                console.error('Error getting file for update:', e)
              }
            })
          },
          async getByKey(key) {
            const tx = this.db.transaction(STORE_NAME, 'readonly')
            const store = tx.objectStore(STORE_NAME)
            return new Promise((resolve) => {
              const request = store.get(key)
              request.onsuccess = () => resolve(request.result)
            })
          },
          async getByName(name) {
            const tx = this.db.transaction(STORE_NAME, 'readonly')
            const store = tx.objectStore(STORE_NAME)
            const index = store.index('name')
            return new Promise((resolve) => {
              const request = index.get(name)
              request.onsuccess = () => resolve(request.result)
            })
          },
          async getByDate(date) {
            const tx = this.db.transaction(STORE_NAME, 'readonly')
            const store = tx.objectStore(STORE_NAME)
            const index = store.index('createdAt')
            return new Promise((resolve) => {
              const request = index.getAll(IDBKeyRange.only(date))
              request.onsuccess = () => resolve(request.result)
            })
          },
          async getLastEntry() {
            const tx = this.db.transaction(STORE_NAME, 'readonly')
            const store = tx.objectStore(STORE_NAME)
            return new Promise((resolve) => {
              const request = store.openCursor(null, 'prev')
              request.onsuccess = () => resolve(request.result?.value || null)
            })
          },
          getAll(callback) {
            this.transaction((objectStore) => {
              const request = objectStore.getAll()
              request.onsuccess = () => callback(request.result)
            })
          },
          forEach(callback) {
            this.transaction((objectStore) => {
              objectStore.openCursor().onsuccess = (event) => {
                const cursor = event.target.result
                if (!cursor) return
                callback({ data: cursor.value, key: cursor.key })
                cursor.continue()
              }
            })
          },
        }
      }

      // initialize local indexdb
      const codeDB = CodeDB()

      // Wait for dependencies to load
      async function initEditor(didRetry = false) {
        await codeDB.initialize()
        if (typeof require === 'undefined' || typeof ts === 'undefined') {
          setTimeout(() => initEditor(true), 300)
          return
        }

        require.config({ paths: { vs: 'https://unpkg.com/monaco-editor@latest/min/vs' } })

        require(['vs/editor/editor.main'], async () => {
          const editorContainer = document.getElementById('editor')
          const loadingOverlay = document.getElementById('loading-overlay')

          console.log({ codeDB })

          // Define custom GitHub Dark theme for Monaco
          monaco.editor.defineTheme('github-dark', {
            base: 'vs-dark',
            inherit: true,
            rules: [
              { token: '', foreground: 'c9d1d9', background: '0d1117' },
              { token: 'comment', foreground: '8b949e', fontStyle: 'italic' },
              { token: 'keyword', foreground: 'ff7b72' },
              { token: 'string', foreground: 'a5d6ff' },
              { token: 'number', foreground: '79c0ff' },
              { token: 'type', foreground: 'ffa657' },
              { token: 'variable', foreground: 'ffa657' },
              { token: 'function', foreground: 'd2a8ff' },
              { token: 'constant', foreground: '79c0ff' },
            ],
            colors: {
              'editor.background': '#0d1117',
              'editor.foreground': '#c9d1d9',
              'editor.lineHighlightBackground': '#161b22',
              'editorLineNumber.foreground': '#8b949e',
              'editorLineNumber.activeForeground': '#c9d1d9',
              'editor.selectionBackground': '#264f78',
              'editor.inactiveSelectionBackground': '#1f3448',
              'editorCursor.foreground': '#58a6ff',
              'editorWhitespace.foreground': '#484f58',
              'editorIndentGuide.background': '#21262d',
              'editorIndentGuide.activeBackground': '#30363d',
              'scrollbarSlider.background': '#30363d80',
              'scrollbarSlider.hoverBackground': '#58a6ff80',
              'scrollbarSlider.activeBackground': '#58a6ffc0',
            },
          })

          const lastEntry = codeDB.lastEntry
          console.log({ lastEntry })

          const editor = monaco.editor.create(editorContainer, {
            value:
              codeDB.lastEntry?.code ??
              `/**
 * @file snippet.ts
 * @date ${new Date().toLocaleDateString('en-US', { dateStyle: 'short' })}
 */

console.log('Hello, world!')
`,
            language: 'typescript',
            theme: 'github-dark',
            automaticLayout: true,
            fontSize: 14,
            lineHeight: 22,
            padding: { top: 16, bottom: 16 },
            minimap: { enabled: false },
            scrollBeyondLastLine: false,
            fontFamily: "'JetBrains Mono', 'Fira Code', 'Consolas', monospace",
            fontLigatures: true,
            renderLineHighlight: 'line',
            scrollbar: {
              verticalScrollbarSize: 8,
              horizontalScrollbarSize: 8,
            },
          })

          // Hide loading overlay and show editor
          setTimeout(
            () => {
              editorContainer.classList.remove('opacity-0')
              editorContainer.classList.add('fade-in')
              setTimeout(() => {
                loadingOverlay.style.display = 'none'
              }, 300)
            },
            didRetry ? 500 : 300
          )

          // auto-save current content when leaving page...
          window.addEventListener('beforeunload', () => {
            if (currentFileId) {
              codeDB.update(currentFileId, editor.getValue())
            } else {
              const code = editor.getValue()
              if (code.trim()) {
                codeDB.save(code, (result) => {
                  console.log('File auto-saved on page unload:', result)
                })
              }
            }
          })

          const output = document.getElementById('output')
          const outputText = document.getElementById('output-text')
          const tsVersion = document.getElementById('ts-version')
          const runBtn = document.getElementById('run-btn')
          const saveBtn = document.getElementById('save-btn')
          const clearBtn = document.getElementById('clear-output')
          const resizeHandle = document.getElementById('resize-handle')

          // Version dropdown elements
          const versionBtn = document.getElementById('version-btn')
          const versionDropdown = document.getElementById('version-dropdown')
          const selectedVersion = document.getElementById('selected-version')
          const versionOptions = document.querySelectorAll('.version-option')

          // Files dropdown elements
          const filesBtn = document.getElementById('files-btn')
          const filesDropdown = document.getElementById('files-dropdown')
          const selectedFile = document.getElementById('selected-file')
          const filesList = document.getElementById('files-list')
          const newFileBtn = document.getElementById('new-file-btn')

          // Current file tracking
          let currentFileId = codeDB.lastEntry?.id || null
          let currentFileName = codeDB.lastEntry?.name || 'New File'
          selectedFile.textContent = currentFileName

          // Function to extract filename from code
          function extractFileName(code) {
            const FILE_NAME_REGEX = /@file\s+([^\s*]+)/i
            const match = code.match(FILE_NAME_REGEX)
            return match ? match[1] : null
          }

          // Function to update displayed filename
          function updateDisplayedFileName() {
            const code = editor.getValue()
            const extractedName = extractFileName(code)

            if (extractedName) {
              currentFileName = extractedName
              selectedFile.textContent = extractedName
            } else if (!currentFileId) {
              // Only show "New File" if we don't have a saved file
              selectedFile.textContent = 'New File'
            }
          }

          // Update filename when code changes
          editor.onDidChangeModelContent(() => {
            updateDisplayedFileName()
          })

          // Settings modal elements
          const settingsBtn = document.getElementById('settings-btn')
          const settingsModal = document.getElementById('settings-modal')
          const closeSettings = document.getElementById('close-settings')
          const applySettings = document.getElementById('apply-settings')
          const resetSettings = document.getElementById('reset-settings')

          // Settings controls
          const fontSizeInput = document.getElementById('font-size')
          const fontSizeValue = document.getElementById('font-size-value')
          const lineHeightInput = document.getElementById('line-height')
          const lineHeightValue = document.getElementById('line-height-value')
          const minimapToggle = document.getElementById('minimap-toggle')
          const ligaturesToggle = document.getElementById('ligatures-toggle')
          const lineNumbersToggle = document.getElementById('line-numbers-toggle')

          // TypeScript compiler options controls
          const strictToggle = document.getElementById('strict-toggle')
          const noImplicitAnyToggle = document.getElementById('no-implicit-any-toggle')
          const strictNullChecksToggle = document.getElementById('strict-null-checks-toggle')
          const noUnusedLocalsToggle = document.getElementById('no-unused-locals-toggle')
          const noUnusedParametersToggle = document.getElementById('no-unused-parameters-toggle')
          const moduleSelect = document.getElementById('module-select')

          // Set TypeScript version
          tsVersion.innerText = `v${ts.version}`

          // Current compiler options
          let currentTarget = ts.ScriptTarget.ES2022
          let compilerOptions = {
            module: ts.ModuleKind.ES2015,
            target: ts.ScriptTarget.ES2022,
            strict: false,
            noImplicitAny: false,
            strictNullChecks: false,
            noUnusedLocals: false,
            noUnusedParameters: false,
          }

          // Resizable output panel
          let isResizing = false
          let startY = 0
          let startHeight = 0

          resizeHandle.addEventListener('mousedown', (e) => {
            isResizing = true
            startY = e.clientY
            startHeight = output.offsetHeight
            document.body.style.cursor = 'ns-resize'
            document.body.style.userSelect = 'none'
          })

          document.addEventListener('mousemove', (e) => {
            if (!isResizing) return
            const delta = startY - e.clientY
            const newHeight = Math.max(100, Math.min(window.innerHeight - 100, startHeight + delta))
            output.style.height = newHeight + 'px'
          })

          document.addEventListener('mouseup', () => {
            if (isResizing) {
              isResizing = false
              document.body.style.cursor = ''
              document.body.style.userSelect = ''
            }
          })

          // Version dropdown handlers
          versionBtn.addEventListener('click', (e) => {
            e.stopPropagation()
            versionDropdown.classList.toggle('hidden')
          })

          versionOptions.forEach((option) => {
            option.addEventListener('click', () => {
              const version = option.getAttribute('data-version')
              selectedVersion.textContent = version
              versionDropdown.classList.add('hidden')

              // Update transpile target
              const targetMap = {
                ES5: ts.ScriptTarget.ES5,
                ES2015: ts.ScriptTarget.ES2015,
                ES2020: ts.ScriptTarget.ES2020,
                ES2022: ts.ScriptTarget.ES2022,
                ESNext: ts.ScriptTarget.ESNext,
              }
              currentTarget = targetMap[version] || ts.ScriptTarget.ES2022
              compilerOptions.target = currentTarget
            })
          })

          // Close dropdown when clicking outside
          document.addEventListener('click', () => {
            versionDropdown.classList.add('hidden')
            filesDropdown.classList.add('hidden')
          })

          // Files dropdown handlers
          async function loadFiles() {
            codeDB.getAll((files) => {
              filesList.innerHTML = ''
              if (files.length === 0) {
                filesList.innerHTML = '<div class="px-3 py-2 text-xs text-gh-secondary italic">No saved files</div>'
                return
              }

              files
                .sort((a, b) => b.updatedAt - a.updatedAt)
                .forEach((file) => {
                  const fileButton = document.createElement('button')
                  fileButton.className =
                    'file-option w-full px-3 py-2 text-xs text-left text-gh-primary hover:bg-gh-secondary transition-colors truncate'
                  fileButton.setAttribute('data-file-id', file.id)
                  fileButton.textContent = file.name
                  fileButton.title = file.name

                  if (file.id === currentFileId) {
                    fileButton.classList.add('bg-gh-tertiary')
                  }

                  fileButton.addEventListener('click', () => switchToFile(file.id))
                  filesList.appendChild(fileButton)
                })
            })
          }

          async function switchToFile(fileId) {
            // Save current file before switching
            if (currentFileId) {
              codeDB.update(currentFileId, editor.getValue())
            } else {
              // Save new file if it has content
              const currentCode = editor.getValue()
              if (currentCode.trim()) {
                codeDB.save(currentCode, (result) => {
                  console.log('New file auto-saved before switch:', result)
                })
              }
            }

            // Load the new file
            const file = await codeDB.getByKey(fileId)
            if (file) {
              currentFileId = file.id
              currentFileName = file.name
              selectedFile.textContent = currentFileName
              editor.setValue(file.code)
              filesDropdown.classList.add('hidden')
              loadFiles() // Refresh list to update active state
            }
          }

          filesBtn.addEventListener('click', (e) => {
            e.stopPropagation()
            filesDropdown.classList.toggle('hidden')
            if (!filesDropdown.classList.contains('hidden')) {
              loadFiles()
            }
          })

          newFileBtn.addEventListener('click', () => {
            // Save current file before creating new
            if (currentFileId) {
              codeDB.update(currentFileId, editor.getValue())
            } else {
              const currentCode = editor.getValue()
              if (currentCode.trim()) {
                codeDB.save(currentCode, (result) => {
                  console.log('Previous file saved before new:', result)
                })
              }
            }

            // Create new file
            currentFileId = null
            currentFileName = 'snippet.ts'
            selectedFile.textContent = currentFileName
            editor.setValue(`/**
 * @file ${currentFileName}
 * @date ${new Date().toLocaleDateString('en-US', { dateStyle: 'short' })}
 */

console.log('Hello, world!')
`)
            filesDropdown.classList.add('hidden')
          })

          // Initial load of files
          loadFiles()

          // Save button handler
          function saveCurrentFile() {
            const code = editor.getValue()

            if (currentFileId) {
              // Update existing file
              codeDB.update(currentFileId, code, (result) => {
                currentFileName = result.name
                selectedFile.textContent = result.name
                console.log('File updated:', result)
                loadFiles() // Refresh the files list to show updated name

                // Show visual feedback
                saveBtn.style.color = '#2ea043'
                setTimeout(() => {
                  saveBtn.style.color = ''
                }, 500)
              })
            } else {
              // Save new file
              codeDB.save(code, (result) => {
                currentFileId = result.id
                currentFileName = result.name
                selectedFile.textContent = result.name
                console.log('New file saved:', result)
                loadFiles() // Refresh the files list

                // Show visual feedback
                saveBtn.style.color = '#2ea043'
                setTimeout(() => {
                  saveBtn.style.color = ''
                }, 500)
              })
            }
          }

          saveBtn.addEventListener('click', () => {
            saveCurrentFile()
          })

          // Keyboard shortcut for save (Ctrl+S / Cmd+S)
          editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyS, () => {
            saveCurrentFile()
          })

          // Settings modal handlers
          settingsBtn.addEventListener('click', () => {
            settingsModal.classList.remove('hidden')
            settingsModal.classList.add('flex')
          })

          closeSettings.addEventListener('click', () => {
            settingsModal.classList.add('hidden')
            settingsModal.classList.remove('flex')
          })

          settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) {
              settingsModal.classList.add('hidden')
              settingsModal.classList.remove('flex')
            }
          })

          // Settings controls
          fontSizeInput.addEventListener('input', (e) => {
            fontSizeValue.textContent = e.target.value + 'px'
          })

          lineHeightInput.addEventListener('input', (e) => {
            lineHeightValue.textContent = e.target.value + 'px'
          })

          // Toggle helpers
          function toggleSwitch(button) {
            const isEnabled = button.getAttribute('data-enabled') === 'true'
            const newState = !isEnabled
            button.setAttribute('data-enabled', newState)

            const toggle = button.querySelector('span')
            if (newState) {
              button.classList.remove('bg-gh-secondary')
              button.classList.add('bg-gh-accent')
              toggle.classList.remove('translate-x-1')
              toggle.classList.add('translate-x-6')
            } else {
              button.classList.remove('bg-gh-accent')
              button.classList.add('bg-gh-secondary')
              toggle.classList.remove('translate-x-6')
              toggle.classList.add('translate-x-1')
            }
            return newState
          }

          minimapToggle.addEventListener('click', () => toggleSwitch(minimapToggle))
          ligaturesToggle.addEventListener('click', () => toggleSwitch(ligaturesToggle))
          lineNumbersToggle.addEventListener('click', () => toggleSwitch(lineNumbersToggle))

          // TypeScript option toggles
          strictToggle.addEventListener('click', () => toggleSwitch(strictToggle))
          noImplicitAnyToggle.addEventListener('click', () => toggleSwitch(noImplicitAnyToggle))
          strictNullChecksToggle.addEventListener('click', () => toggleSwitch(strictNullChecksToggle))
          noUnusedLocalsToggle.addEventListener('click', () => toggleSwitch(noUnusedLocalsToggle))
          noUnusedParametersToggle.addEventListener('click', () => toggleSwitch(noUnusedParametersToggle))

          // Apply settings
          applySettings.addEventListener('click', () => {
            const fontSize = parseInt(fontSizeInput.value)
            const lineHeight = parseInt(lineHeightInput.value)
            const minimap = minimapToggle.getAttribute('data-enabled') === 'true'
            const ligatures = ligaturesToggle.getAttribute('data-enabled') === 'true'
            const lineNumbers = lineNumbersToggle.getAttribute('data-enabled') === 'true'

            // Update editor options
            editor.updateOptions({
              fontSize: fontSize,
              lineHeight: lineHeight,
              minimap: { enabled: minimap },
              fontLigatures: ligatures,
              lineNumbers: lineNumbers ? 'on' : 'off',
            })

            // Update compiler options
            const moduleMap = {
              None: ts.ModuleKind.None,
              CommonJS: ts.ModuleKind.CommonJS,
              AMD: ts.ModuleKind.AMD,
              UMD: ts.ModuleKind.UMD,
              System: ts.ModuleKind.System,
              ES2015: ts.ModuleKind.ES2015,
              ES2020: ts.ModuleKind.ES2020,
              ESNext: ts.ModuleKind.ESNext,
            }

            compilerOptions = {
              module: moduleMap[moduleSelect.value] || ts.ModuleKind.ES2015,
              target: currentTarget,
              strict: strictToggle.getAttribute('data-enabled') === 'true',
              noImplicitAny: noImplicitAnyToggle.getAttribute('data-enabled') === 'true',
              strictNullChecks: strictNullChecksToggle.getAttribute('data-enabled') === 'true',
              noUnusedLocals: noUnusedLocalsToggle.getAttribute('data-enabled') === 'true',
              noUnusedParameters: noUnusedParametersToggle.getAttribute('data-enabled') === 'true',
            }

            settingsModal.classList.add('hidden')
            settingsModal.classList.remove('flex')
          })

          // Reset settings
          resetSettings.addEventListener('click', () => {
            // Reset editor settings
            fontSizeInput.value = 14
            fontSizeValue.textContent = '14px'
            lineHeightInput.value = 22
            lineHeightValue.textContent = '22px'

            // Helper to reset toggle to off
            const resetToggleOff = (toggle) => {
              toggle.setAttribute('data-enabled', 'false')
              toggle.classList.remove('bg-gh-accent')
              toggle.classList.add('bg-gh-secondary')
              toggle.querySelector('span').classList.remove('translate-x-6')
              toggle.querySelector('span').classList.add('translate-x-1')
            }

            // Helper to reset toggle to on
            const resetToggleOn = (toggle) => {
              toggle.setAttribute('data-enabled', 'true')
              toggle.classList.remove('bg-gh-secondary')
              toggle.classList.add('bg-gh-accent')
              toggle.querySelector('span').classList.remove('translate-x-1')
              toggle.querySelector('span').classList.add('translate-x-6')
            }

            resetToggleOff(minimapToggle)
            resetToggleOn(ligaturesToggle)
            resetToggleOn(lineNumbersToggle)

            // Reset TypeScript options
            resetToggleOff(strictToggle)
            resetToggleOff(noImplicitAnyToggle)
            resetToggleOff(strictNullChecksToggle)
            resetToggleOff(noUnusedLocalsToggle)
            resetToggleOff(noUnusedParametersToggle)

            moduleSelect.value = 'ES2015'

            // Apply defaults
            editor.updateOptions({
              fontSize: 14,
              lineHeight: 22,
              minimap: { enabled: false },
              fontLigatures: true,
              lineNumbers: 'on',
            })

            compilerOptions = {
              module: ts.ModuleKind.ES2015,
              target: currentTarget,
              strict: false,
              noImplicitAny: false,
              strictNullChecks: false,
              noUnusedLocals: false,
              noUnusedParameters: false,
            }
          })

          // Clear output handler
          clearBtn.addEventListener('click', () => {
            output.classList.add('hidden')
            outputText.textContent = ''
          })

          // Run code handler
          runBtn.addEventListener('click', () => {
            const code = editor.getValue()

            const logs = []
            const errors = []
            const originalLog = console.log
            const originalError = console.error

            function safeJoin(args = []) {
              try {
                return args
                  .map((item) => {
                    if (!item) return item
                    if (item instanceof URL) return `URL(${item.href})`
                    if (typeof item === 'object') return JSON.stringify(item)
                    if (item instanceof Error) return ['Error:', item.message].join(' ')
                    return String(item)
                  })
                  .join(' ')
              } catch (e) {
                return args.join(' ')
              }
            }

            console.log = (...args) => {
              logs.push(safeJoin(args))
              originalLog(...args)
            }

            console.error = (...args) => {
              errors.push('Error: ' + safeJoin(args))
              originalError(...args)
            }

            try {
              // Transpile TypeScript to JavaScript
              const result = ts.transpileModule(code, {
                compilerOptions: compilerOptions,
              })

              // Execute the transpiled JavaScript
              eval(result.outputText)

              const allOutput = [...logs, ...errors]
              outputText.textContent =
                allOutput.length > 0 ? allOutput.join('\n') : ' Code executed successfully (no output)'
              outputText.className =
                errors.length > 0
                  ? 'text-sm font-mono text-red-500 leading-relaxed'
                  : 'text-sm font-mono text-green-500 leading-relaxed'
            } catch (err) {
              outputText.textContent = ' ' + err.message
              outputText.className = 'text-sm font-mono text-red-500 leading-relaxed'
            }

            console.log = originalLog
            console.error = originalError
            output.classList.remove('hidden')
          })

          // Run on Cmd/Ctrl + Enter
          editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.Enter, () => {
            runBtn.click()
          })
        })
      }

      // Start initialization
      initEditor()
    </script>
  </body>
</html>
