---
import { getCollection } from 'astro:content'
import SiteLayout from '@/layouts/SiteLayout.astro'
import BentoBox from '@/layouts/BentoBox.astro'
import { db, sql, PageMetrics } from 'astro:db'
import { eq } from 'astro:db'

export const prerender = true

// =====================================
// Home Page
// =====================================

const blog = await getCollection('blog')
const posts = blog.sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
)

const featured = posts.at(0)!
const pageMetricsData = await db
  .select()
  .from(PageMetrics)
  .where(eq(PageMetrics.route, '/'))
  .limit(1)

const feed = posts.slice(1).map(({ data, id }) => ({
  name: data.title,
  date: data.updatedDate ?? data.pubDate,
  href: `/blog/${id}`,
}))

const metrics = pageMetricsData.at(0)

if (metrics) {
  await db
    .update(PageMetrics)
    .set({ views: sql`views + 1`, updatedAt: new Date() })
    .where(eq(PageMetrics.route, '/'))

  console.log({ metrics })
}
---

<SiteLayout
  title="Home"
  className="justify-center grow"
  transition:animate="none"
>
  <BentoBox className="lg:max-w-7xl" featured={featured} feed={feed} />
  <page-metrics
    views={metrics?.views}
    likes={metrics?.likes}
    comments={metrics?.comments}></page-metrics>
</SiteLayout>
<script>
  import { PageMetrics } from '@/components/web/PageMetrics'

  PageMetrics.register()
</script>
