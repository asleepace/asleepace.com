---
import { getCollection } from 'astro:content'
import SiteLayout from '@/layouts/SiteLayout.astro'
import BentoBox, { type FeedItem } from '@/layouts/BentoBox.astro'
import { getRecentReports } from '@/lib/db/daily-reports'

Astro.response.headers.set('Cache-Control', 'public, max-age=60, s-maxage=60')

const cached = {
  lastCachedAt: undefined,
  dailyReports: [] as FeedItem[],
  clearCached() {
    this.lastCachedAt = undefined
    this.dailyReports = []
  },
  minsAgo() {
    return (Date.now() - this.lastCachedAt) / 1_000
  },
}

export const prerender = false

// =====================================
// Home Page
// =====================================

const blog = await getCollection('blog')
const posts = blog.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())

const randomIndexOfLastFour = Math.floor(Math.random() * posts.length) % 4
const featured = posts.at(randomIndexOfLastFour)!

const feed = posts.slice(1).map(({ data, id }) => ({
  name: data.title,
  date: data.updatedDate ?? data.pubDate,
  href: `/blog/${id}`,
}))

if (cached.minsAgo() >= 10) {
  cached.clearCached()
}

if (!cached.dailyReports) {
  console.log('[home] fetching recent reports...')
  const dailyReports = await getRecentReports({ limit: 2 })
  console.log('[home] finished!')
  cached.dailyReports = dailyReports.map((report): FeedItem => {
    const titleDate = report.market_date.toLocaleDateString('en-US', {
      timeZone: 'America/New_York',
      dateStyle: 'medium',
    })
    return {
      date: new Date(report.market_date),
      href: `/daily-report?date=${report.market_date.toISOString().split('T')[0]}`,
      name: `The Daily Report â€¢ ${titleDate}`,
    }
  })
}
---

<SiteLayout title="Home" className="justify-center grow" transition:animate="none" htmx>
  <BentoBox className="lg:max-w-7xl" featured={featured} feed={[...cached.dailyReports, ...feed]} />
</SiteLayout>
