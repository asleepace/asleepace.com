---
import { stockMarket } from '@/lib/utils/stock-market'

// DailyReportCard.astro
interface Props {
  date: string
  eodTarget: number
  currentPrice: number
  percentChange: number
  sentiment: 'bullish' | 'bearish' | 'neutral'
  volume: 'thin' | 'heavy' | 'average'
  confidence: number
  bullPercentage: number
  bearPercentage: number
  marketStatus: 'open' | 'closed' | 'premarket' | 'afterhours'
  keyFactors: Array<{
    icon: string
    text: string
    color: 'blue' | 'purple' | 'amber' | 'green' | 'red' | 'slate'
  }>
}

const {
  date,
  eodTarget,
  currentPrice,
  percentChange,
  sentiment,
  volume,
  confidence,
  bullPercentage,
  bearPercentage,
  // marketStatus,
  keyFactors,
} = Astro.props

const onCardClick = true

const isPositive = percentChange > 0
const isNegative = percentChange < 0

// convert mindnight UTC date string to date with current ET time
const etDate = stockMarket.setCurrentUTCTime(new Date(date))
const marketStatus = stockMarket.getMarketStatus(etDate)
const etTime = etDate.toLocaleTimeString('en-US', {
  timeZone: 'America/New_York',
  timeStyle: 'short',
})

const timezone = stockMarket.getTimezoneShortName(etDate)

const sentimentConfig = {
  bullish: {
    bgGlow: 'from-green-500/5',
    textColor: 'text-green-400',
    borderColor: 'border-green-500/30',
    bgColor: 'bg-green-500/20',
    icon: 'trending-up',
    glowEffect: 'drop-shadow-[0_0_20px_rgba(74,222,128,0.3)]',
  },
  bearish: {
    bgGlow: 'from-red-500/5',
    textColor: 'text-red-400',
    borderColor: 'border-red-500/30',
    bgColor: 'bg-red-500/20',
    icon: 'trending-down',
    glowEffect: 'drop-shadow-[0_0_20px_rgba(248,113,113,0.3)]',
  },
  neutral: {
    bgGlow: 'from-slate-500/5',
    textColor: 'text-slate-400',
    borderColor: 'border-slate-500/30',
    bgColor: 'bg-slate-500/20',
    icon: 'minus',
    glowEffect: '',
  },
}

const config = sentimentConfig[sentiment]
const priceChangeColor = isPositive ? 'text-green-400' : isNegative ? 'text-red-400' : 'text-slate-400'
const arrowIcon = isPositive ? 'arrow-up' : isNegative ? 'arrow-down' : 'minus'

const confidenceGradient =
  confidence >= 70
    ? 'from-green-500 to-green-400'
    : confidence >= 50
      ? 'from-yellow-500 to-yellow-400'
      : 'from-red-500 to-red-400'

const volumeConfig = {
  thin: { icon: 'activity', label: 'Thin Vol' },
  heavy: { icon: 'bar-chart-3', label: 'Heavy Vol' },
  average: { icon: 'activity', label: 'Avg Vol' },
}

const marketStatusLabels = {
  open: 'Market Open',
  closed: 'Market Closed',
  premarket: 'Pre-Market',
  afterhours: 'After Hours',
}

const iconColorMap = {
  blue: { bg: 'bg-blue-500/20', hover: 'group-hover:bg-blue-500/30', icon: 'text-blue-400' },
  purple: { bg: 'bg-purple-500/20', hover: 'group-hover:bg-purple-500/30', icon: 'text-purple-400' },
  amber: { bg: 'bg-amber-500/20', hover: 'group-hover:bg-amber-500/30', icon: 'text-amber-400' },
  green: { bg: 'bg-green-500/20', hover: 'group-hover:bg-green-500/30', icon: 'text-green-400' },
  red: { bg: 'bg-red-500/20', hover: 'group-hover:bg-red-500/30', icon: 'text-red-400' },
  slate: { bg: 'bg-slate-500/20', hover: 'group-hover:bg-slate-500/30', icon: 'text-slate-400' },
}

const marketStatusText = marketStatusLabels[marketStatus]
---

<div
  id={'report-card'}
  data-daily-report
  class="aspect-video w-full max-w-2xl bg-linear-to-br from-slate-900 to-slate-800 rounded-xl md:rounded-2xl shadow-2xl p-3 md:p-8 flex flex-col justify-between border border-slate-700 relative overflow-hidden"
  class:list={[onCardClick && 'cursor-pointer hover:border-slate-600 hover:shadow-3xl transition-all']}
>
  <!-- Subtle background glow for sentiment -->
  <div class={`absolute inset-0 bg-linear-to-br ${config.bgGlow} to-transparent pointer-events-none`}></div>

  <!-- Header -->
  <div class="flex items-start justify-between relative z-10">
    <div>
      <p class="text-[16px] md:text-2xl font-bold text-white">The Daily Report</p>
      <p class="text-slate-400 text-[10px] md:text-sm mt-0 md:mt-1">
        <span>{date}</span>
        <span>{'•'}</span>
        <span>{etTime} ({timezone})</span>
      </p>

      <!-- Status badges -->
      <div class="flex gap-2 mt-2">
        <div
          class={`inline-flex items-center gap-1.5 px-1.5 md:px-2.5 py-0.5 md:py-1 rounded-full ${config.bgColor} border ${config.borderColor}`}
        >
          <i data-lucide={config.icon} class={`w-1.5 h-1.5 md:w-3 md:h-3 ${config.textColor}`}></i>
          <span class={`text-[10px] font-normal md:font-semibold ${config.textColor} capitalize`}>{sentiment}</span>
        </div>
        <div
          class="inline-flex items-center gap-1.5 px-1.5 md:px-2.5 py-0.5 md:py-1 rounded-full bg-slate-700/50 border border-slate-600/30"
        >
          <i data-lucide={volumeConfig[volume].icon} class="w-2 h-2 md:w-3 md:h-3 text-slate-400"></i>
          <span class="md:text-xs text-[10px] font-normal md:font-medium text-slate-400"
            >{volumeConfig[volume].label}</span
          >
        </div>
      </div>
    </div>

    <div class="text-right">
      <div class="text-[8px] md:text-xs text-slate-500 mb-0 md:mb-1">EOD Target</div>
      <div class={`text-xl md:text-4xl font-bold ${config.textColor} ${config.glowEffect}`}>
        ${eodTarget}
      </div>
      <div
        class={`flex items-center justify-end gap-0.5 md:gap-1 text-[10px] md:text-sm ${priceChangeColor} font-medium mt-0 md:mt-1`}
      >
        <i data-lucide={arrowIcon} class="w-3 h-3"></i>
        <span>{percentChange > 0 ? '+' : ''}{percentChange}%</span>
      </div>

      <!-- Confidence bar -->
      <div class="mt-0 md:mt-2 w-24">
        <div
          class="flex items-center gap-1 md:gap-0 justify-end md:justify-between text-[10px] md:text-xs text-slate-500 mb-1"
        >
          <span>Confidence</span>
          <span class="text-slate-400 font-semibold">{confidence}%</span>
        </div>
        <div class="h-1 md:h-1.5 bg-slate-700/50 rounded-full overflow-hidden">
          <div class={`h-full bg-linear-to-r ${confidenceGradient} rounded-full`} style={`width: ${confidence}%`}></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Key Factors -->
  <div class="space-y-1.5 md:space-y-2.5 relative z-10">
    {
      keyFactors.slice(0, 3).map((factor) => {
        const colors = iconColorMap[factor.color]
        let safeIcon = factor.icon

        if (factor.icon === 'bank') safeIcon = 'landmark'

        return (
          <div class="flex items-center gap-2 md:gap-3 text-slate-200 group hover:text-white transition-colors">
            <div
              class={`shrink-0 w-4 h-4 md:w-8 md:h-8 rounded md:rounded-lg ${colors.bg} flex items-center justify-center ${colors.hover} transition-colors`}
            >
              <i data-lucide={safeIcon} class={`w-2 h-2 md:w-4 md:h-4 ${colors.icon}`} />
            </div>
            <span class="text-xs sm:text-sm font-normal tracking-tight md:tracking-normal md:font-medium">
              {factor.text}
            </span>
          </div>
        )
      })
    }
  </div>

  <!-- Footer stats -->
  <div class="flex items-center justify-between text-[10px] md:text-xs text-slate-500 relative z-10 pt-1.5 md:pt-3 border-t border-slate-700/50">
    <div class="flex items-center gap-4">
      <div class="flex items-center gap-1.5">
        <i data-lucide="clock" class="w-3 h-3"></i>
        <span>{marketStatusText}</span>
      </div>
      <div class="flex items-center gap-1.5">
        <span class="text-slate-400">Current:</span>
        <span class="text-slate-300 font-semibold">${currentPrice}</span>
      </div>
    </div>
    <div class="flex items-center gap-1.5">
      <span class="text-slate-400">{bullPercentage}% Bulls</span>
      <span class="text-slate-600">•</span>
      <span class="text-slate-400">{bearPercentage}% Bears</span>
    </div>
  </div>
</div>

<script>
  import { downloadCardAsImage } from '@/lib/server/download-to-image'

  const card = document.getElementById('report-card')

  if (card) {
    card.style.cursor = 'pointer'

    card.addEventListener('click', async (e) => {
      try {
        // Prevent double clicks
        if (card.dataset.downloading === 'true') return
        card.dataset.downloading = 'true'

        await downloadCardAsImage('report-card', `daily-report-card-${+new Date()}`)

        card.dataset.downloading = 'false'
      } catch (error) {
        console.error('Download failed:', error)
        alert('Failed to download image')
        card.dataset.downloading = 'false'
      }
    })
  }
</script>

<style>
  [data-daily-report] {
    font-family:
      ui-sans-serif,
      system-ui,
      -apple-system,
      BlinkMacSystemFont,
      'Segoe UI',
      Roboto,
      sans-serif;
    line-height: 1.5;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  [data-daily-report] *,
  [data-daily-report] *::before,
  [data-daily-report] *::after {
    box-sizing: border-box;
  }
</style>

<script is:inline src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
<script is:inline>
  lucide.createIcons()
</script>
