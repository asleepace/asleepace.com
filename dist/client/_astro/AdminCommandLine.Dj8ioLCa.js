import{j as c}from"./jsx-runtime.D_zvdyIk.js";import{r}from"./index.BVOCwoKb.js";import{c as f}from"./clsx.B-dksMZM.js";function h({data:t}){const e=r.useRef(null);return r.useEffect(()=>{e.current&&(e.current.scrollTop=e.current.scrollHeight)},[t.length]),c.jsx("div",{ref:e,className:"flex flex-col justify-start gap-y-0 p-2 flex-1 overflow-auto scrollbar-none",children:t.map((s,i)=>c.jsx(g,{result:s},i))})}function g({result:t}){const e=t.type==="error",s=t?.command&&Array.isArray(t.command)?t.command.join(" "):t.command;return c.jsxs("div",{className:"flex flex-col gap-y-1 flex-grow text-sm",children:[c.jsxs("p",{className:"tracking-wide font-mono",children:[c.jsx("span",{className:f("text-purple-500",e&&"text-white"),children:t.whoami}),c.jsx("span",{className:"text-gray-500",children:"@"}),c.jsx("span",{className:f("text-blue-500",e&&"text-red-500"),children:t.pwd}),c.jsxs("span",{className:"text-green-500 mx-2",children:["$ ",s.toString()]})]}),t.output&&c.jsx("pre",{className:"text-zinc-500 mb-2",children:t.output})]})}const S="x-shell-pid",w=async()=>{const t=await fetch("/api/shell/stream",{method:"HEAD",credentials:"include"});return console.log("[fetchProcessPid] status:",t.status),Number(t.headers.get(S))};function v(){const[t,e]=r.useState(void 0),s=r.useCallback(()=>w().then(o=>(console.log("[usePid] new pid:",o),e(o),o)).catch(o=>{console.error("[usePid] error:",o),e(void 0)}),[]),i=r.useCallback(()=>{console.warn("[usePid] resetting!"),e(void 0)},[]);return[t,s,i]}function E(t){const[e,s]=r.useState(),[i,o]=r.useState([]);r.useEffect(()=>{if(e)return()=>{console.log("[useEventSource] closing event source!"),e.close()}},[e]);const l=r.useCallback(a=>{console.log("[useEventSource] creating event source:",a);const n=new EventSource(a);return n.onopen=()=>{console.log("[useEventSource] event source opened:",a),s(n),o([])},n.onerror=()=>{console.warn("[useEventSource] closing: ",!0),n.close(),s(void 0)},n.onmessage=d=>{if(!d.data||typeof d.data!="string")return;const m=t(d);m&&o(x=>[...x,m])},n},[]),u=r.useMemo(()=>{switch(e?.readyState){case EventSource.OPEN:return"open";case EventSource.CLOSED:return"closed";case EventSource.CONNECTING:default:return"connecting"}},[e]);return{eventSource:e,subscribeToEventSource:l,messages:i,state:u}}const p=new TextDecoder;function y(t){if(!t.data)return;const e=new Uint8Array(t.data.split(",").map(Number)),s=e.findLastIndex(n=>n===3),i=p.decode(e.slice(0,s)),l=p.decode(e.slice(s+1)).trim();if(!l||!l.startsWith("{"))return;const u=JSON.parse(l);return{command:u.cmd?.split(" ")??[],output:i,whoami:u.usr,pwd:u.dir,type:"command"}}function b(){const[t,e,s]=v(),{messages:i,subscribeToEventSource:o}=E(y),l=r.useCallback(async()=>{try{const a=await e();if(!a)throw new Error("missing pid");o(`/api/shell/stream?pid=${a}`)}catch(a){console.warn("[useShellStream] error registering shell:",a)}},[e,o]),u=r.useCallback(async a=>{try{const n=await fetch("/api/shell/stream",{method:"POST",body:JSON.stringify({command:a})});if(n.status!==200)throw new Error(n.statusText);return n}catch(n){console.error("[useShellStream] error:",n),s()}},[t,s]);return[i,u,l]}function R(){const t=r.useRef([]).current,e=r.useRef(null),[s,i,o]=b(),l=r.useCallback(async n=>{t.push(n),i(n)?.catch(d=>{console.warn("[AdminCommandLine] error",d)})},[i]),u=r.useCallback(n=>{if(n.key!=="Enter"||n.shiftKey&&n.key==="Enter")return;n.preventDefault();const d=e.current?.value?.trim();if(e.current.value="",!d)return!1;l(d)},[]),a=r.useCallback(n=>{e.current||n&&(e.current=n,n.focus(),o())},[]);return c.jsxs("div",{className:"bg-black rounded-2xl flex-1 p-1 self-stretch max-w-screen-lg max-h-[500px] flex flex-col",children:[c.jsx(h,{data:s}),c.jsxs("div",{className:"flex flex-row px-2 py-1",children:[c.jsx("p",{className:"text-green-500 font-mono text-sm self-center font-bold",children:"$"}),c.jsx("input",{ref:a,id:"cli-input",type:"text",className:"flex flex-shrink font-mono text-sm tracking-wide text-green-500 bg-transparent ring-0 focus:ring-0 focus:outline-none focus:border-orange-500 rounded-md p-2",autoCapitalize:"off",autoComplete:"off",autoCorrect:"off",spellCheck:!1,placeholder:"Run command...",onKeyDown:u})]})]})}export{R as default};
