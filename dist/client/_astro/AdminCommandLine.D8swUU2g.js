import{j as n}from"./jsx-runtime.D_zvdyIk.js";import{r}from"./index.Dy6lLLXr.js";import{c as S}from"./clsx.B-dksMZM.js";function w({data:e}){return n.jsx("div",{className:"flex flex-col gap-y-0 p-2 flex-grow overflow-auto scrollbar-none",children:e.map((o,s)=>n.jsx(y,{result:o},s))})}function y({result:e}){const o=e.type==="error",s=e?.command&&Array.isArray(e.command)?e.command.join(" "):e.command;return n.jsxs("div",{className:"flex flex-col gap-y-1 flex-grow text-sm",children:[n.jsxs("p",{className:"tracking-wide font-mono",children:[n.jsx("span",{className:S("text-purple-500",o&&"text-white"),children:e.whoami}),n.jsx("span",{className:"text-gray-500",children:"@"}),n.jsx("span",{className:S("text-blue-500",o&&"text-red-500"),children:e.pwd}),n.jsxs("span",{className:"text-green-500 mx-2",children:["$ ",s.toString()]})]}),e.output&&n.jsx("pre",{className:"text-zinc-500 mb-2",children:e.output})]})}function N(){const[e,o]=r.useState(void 0);return console.log("[useShellPid] pid:",e),r.useEffect(()=>{fetch("/api/shell/stream",{method:"HEAD"}).then(s=>{console.log("[useShellPid] resp:",s);const c=s.headers.get("x-shell-pid"),l=Number(c);if(console.log("[useShellPid] pid header:",c),!c)throw new Error("No pid found");if(isNaN(l)||l<=0)throw new Error("Invalid pid");o(l)}).catch(s=>{console.error("[useShellPid] error:",s)})},[]),e}const j=e=>o=>{console.log(`[useShellStream] exec "${e}" (${o.status}) ${o.statusText}`)},b=e=>o=>{console.error(`[useShellStream] exec "${e}" error:`,o)};function v(){const[e,o]=r.useState([]),[s,c]=r.useState([]),l=N(),i=r.useCallback(t=>(c(a=>[...a,t]),fetch("/api/shell/stream",{method:"POST",body:JSON.stringify({command:t})}).then(j(t)).catch(b(t))),[l]);return r.useEffect(()=>{if(!l)return;const t=new EventSource("/api/shell/stream"),a=new TextDecoder;return t.onopen=()=>{console.log("[useShellStream] eventSource.onopen()")},console.log("[useShellStream] eventSource:",t),console.log("[useShellStream] eventSource.readyState:",t.readyState),t.onmessage=u=>{if(console.log("[useShellStream] event:",u),typeof u.data!="string"){console.error("[useShellStream] event.data is not a string:",u.data);return}const m=new Uint8Array(u.data.split(",").map(Number)),d=m.findLastIndex(f=>f===3);console.log("[useShellStream] endOfText:",d);const x=a.decode(m.slice(0,d)),h=a.decode(m.slice(d+1));console.log("[useShellStream] output:",x),console.log("[useShellStream] rawMetadata:",h);const p=JSON.parse(h.trim()),g={command:p.cmd?.split(" ")??[],output:x,whoami:p.usr,pwd:p.dir,type:"command"};o(f=>[...f,g])},t.onerror=u=>{console.log("[useShellStream] error:",u)},()=>{console.warn("[useShellStream] closing eventSource..."),t.close()}},[l]),[e,i]}function k(){const e=r.useRef([]).current,o=r.useRef(null),[s,c]=v(),l=r.useCallback(async t=>{e.push(t),c(t).catch(a=>{console.warn("[AdminCommandLine] error",a)})},[c]),i=r.useCallback(t=>{if(t.key!=="Enter"||t.shiftKey&&t.key==="Enter")return;t.preventDefault();const a=o.current?.value?.trim();if(o.current.value="",!a)return!1;l(a)},[]);return n.jsxs("div",{className:"bg-black rounded-2xl flex-1 p-1 self-stretch max-w-screen-lg max-h-[500px] flex flex-col",children:[n.jsx(w,{data:s}),n.jsxs("div",{className:"flex flex-row px-2 py-1",children:[n.jsx("p",{className:"text-green-500 font-mono text-sm self-center font-bold",children:"$"}),n.jsx("input",{ref:o,id:"cli-input",type:"text",className:"flex flex-shrink font-mono text-sm tracking-wide text-green-500 bg-transparent ring-0 focus:ring-0 focus:outline-none focus:border-orange-500 rounded-md p-2",autoCapitalize:"off",autoComplete:"off",autoCorrect:"off",spellCheck:!1,placeholder:"Run command...",onKeyDown:i})]})]})}export{k as default};
