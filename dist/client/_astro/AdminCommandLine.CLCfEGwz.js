import{j as a}from"./jsx-runtime.D_zvdyIk.js";import{r as s}from"./index.Dy6lLLXr.js";import{c as f}from"./clsx.B-dksMZM.js";function h({data:n}){const e=s.useRef(null);return s.useEffect(()=>{e.current&&(e.current.scrollTop=e.current.scrollHeight)},[n.length]),a.jsx("div",{ref:e,className:"flex flex-col justify-start gap-y-0 p-2 flex-1 overflow-auto scrollbar-none",children:n.map((r,i)=>a.jsx(g,{result:r},i))})}function g({result:n}){const e=n.type==="error",r=n?.command&&Array.isArray(n.command)?n.command.join(" "):n.command;return a.jsxs("div",{className:"flex flex-col gap-y-1 flex-grow text-sm",children:[a.jsxs("p",{className:"tracking-wide font-mono",children:[a.jsx("span",{className:f("text-purple-500",e&&"text-white"),children:n.whoami}),a.jsx("span",{className:"text-gray-500",children:"@"}),a.jsx("span",{className:f("text-blue-500",e&&"text-red-500"),children:n.pwd}),a.jsxs("span",{className:"text-green-500 mx-2",children:["$ ",r.toString()]})]}),n.output&&a.jsx("pre",{className:"text-zinc-500 mb-2",children:n.output})]})}const S="x-shell-pid",w=async()=>{const n=await fetch("/api/shell/stream",{method:"HEAD",credentials:"include"});return console.log("[fetchProcessPid] status:",n.status),Number(n.headers.get(S))};function v(){const[n,e]=s.useState(void 0),r=s.useCallback(()=>w().then(o=>(console.log("[usePid] new pid:",o),e(o),o)).catch(o=>{console.error("[usePid] error:",o),e(void 0)}),[]),i=s.useCallback(()=>{console.warn("[usePid] resetting!"),e(void 0)},[]);return[n,r,i]}function E(n){const[e,r]=s.useState(),[i,o]=s.useState([]),u=s.useCallback(d=>{console.log("[useEventSource] creating event source:",d);const t=new EventSource(d);return t.onopen=()=>{console.log("[useEventSource] event source opened:",d),r(t),o([])},t.onerror=()=>{console.warn("[useEventSource] closing: ",!0),t.close(),r(void 0)},t.onmessage=c=>{if(!c.data||typeof c.data!="string")return;const m=n(c);m&&o(x=>[...x,m])},t},[]),l=s.useMemo(()=>{switch(e?.readyState){case EventSource.OPEN:return"open";case EventSource.CLOSED:return"closed";case EventSource.CONNECTING:default:return"connecting"}},[e]);return{eventSource:e,subscribeToEventSource:u,messages:i,state:l}}const p=new TextDecoder;function b(n){if(!n.data)return;const e=new Uint8Array(n.data.split(",").map(Number)),r=e.findLastIndex(t=>t===3),i=p.decode(e.slice(0,r)),u=p.decode(e.slice(r+1)).trim();if(!u||!u.startsWith("{"))return;const l=JSON.parse(u);return{command:l.cmd?.split(" ")??[],output:i,whoami:l.usr,pwd:l.dir,type:"command"}}new TextDecoder;function y(){const[n,e,r]=v(),{messages:i,subscribeToEventSource:o,state:u}=E(b),l=s.useCallback(async()=>{try{const t=await e();if(!t)throw new Error("missing pid");o(`/api/shell/stream?pid=${t}`)}catch(t){console.warn("[useShellStream] error registering shell:",t)}},[e,o]),d=s.useCallback(t=>fetch("/api/shell/stream",{method:"POST",body:JSON.stringify({command:t})}).then(c=>{if(c.status!==200)throw new Error(c.statusText);return c}).catch(c=>{console.error("[useShellStream] error:",c),r()}),[n,r]);return[i,d,l]}function R(){const n=s.useRef([]).current,e=s.useRef(null),[r,i,o]=y(),u=s.useCallback(async t=>{n.push(t),i(t)?.catch(c=>{console.warn("[AdminCommandLine] error",c)})},[i]),l=s.useCallback(t=>{if(t.key!=="Enter"||t.shiftKey&&t.key==="Enter")return;t.preventDefault();const c=e.current?.value?.trim();if(e.current.value="",!c)return!1;u(c)},[]),d=s.useCallback(t=>{e.current||t&&(e.current=t,t.focus(),o())},[]);return a.jsxs("div",{className:"bg-black rounded-2xl flex-1 p-1 self-stretch max-w-screen-lg max-h-[500px] flex flex-col",children:[a.jsx(h,{data:r}),a.jsxs("div",{className:"flex flex-row px-2 py-1",children:[a.jsx("p",{className:"text-green-500 font-mono text-sm self-center font-bold",children:"$"}),a.jsx("input",{ref:d,id:"cli-input",type:"text",className:"flex flex-shrink font-mono text-sm tracking-wide text-green-500 bg-transparent ring-0 focus:ring-0 focus:outline-none focus:border-orange-500 rounded-md p-2",autoCapitalize:"off",autoComplete:"off",autoCorrect:"off",spellCheck:!1,placeholder:"Run command...",onKeyDown:l})]})]})}export{R as default};
